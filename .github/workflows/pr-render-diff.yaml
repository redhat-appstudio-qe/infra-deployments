name: PR Render Diff

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  render-diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      # Check out the BASE branch (trusted code) so we never execute fork code.
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: infra-tools/go.mod

      # Build the render-diff binary from the trusted base branch before
      # switching to the PR head. This ensures a malicious fork cannot
      # inject code that runs with the elevated GITHUB_TOKEN.
      - name: Build render-diff (from base branch)
        working-directory: infra-tools
        run: go build -o bin/render-diff ./cmd/render-diff

      # Fetch the PR head ref and switch to it for analysis.
      - name: Checkout PR head
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-head
          git checkout pr-head

      - name: Generate diffs
        working-directory: infra-tools
        run: |
          mkdir -p ../render-diff-output

          # Generate artifact diff files
          ./bin/render-diff \
            --repo-root=.. \
            --base-ref=origin/${{ github.event.pull_request.base.ref }} \
            --output-mode=ci-artifact-dir \
            --output-dir=../render-diff-output \
            --log-file=../render-diff-debug.log || true

          # Generate Job Summary
          ./bin/render-diff \
            --repo-root=.. \
            --base-ref=origin/${{ github.event.pull_request.base.ref }} \
            --output-mode=ci-summary \
            --log-file=../render-diff-debug.log >> $GITHUB_STEP_SUMMARY || true

          # Generate PR comment body
          ./bin/render-diff \
            --repo-root=.. \
            --base-ref=origin/${{ github.event.pull_request.base.ref }} \
            --output-mode=ci-comment \
            --log-file=../render-diff-debug.log > ../render-diff-comment.md || true

      - name: Post or update PR comment
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f render-diff-comment.md ] && [ -s render-diff-comment.md ]; then
            # Find existing comment with marker
            COMMENT_ID=$(gh api \
              "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              --jq '.[] | select(.body | contains("<!-- render-diff-comment -->")) | .id' \
              2>/dev/null || true)

            if [ -n "$COMMENT_ID" ]; then
              gh api \
                --method PATCH \
                "repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
                -f body="$(cat render-diff-comment.md)"
            else
              gh pr comment "${{ github.event.pull_request.number }}" \
                --repo "${{ github.repository }}" \
                --body-file render-diff-comment.md
            fi
          fi

      - name: Upload diff artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: render-diff-output
          path: |
            render-diff-output/
            render-diff-debug.log
